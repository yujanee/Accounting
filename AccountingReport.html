<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¨˜å¸³çµ±è¨ˆè¡¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans p-8 bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">
  <h2 class="text-2xl font-extrabold text-indigo-700 mb-6">ğŸ“Š æ”¶æ”¯æœˆåˆ¥æ˜ç´°çµ±è¨ˆè¡¨</h2>

  <div class="overflow-x-auto shadow-lg rounded-lg">
    <table id="monthlyTable" class="table-auto w-full border border-gray-300 text-center text-sm bg-white rounded-lg overflow-hidden">
      <thead>
        <tr class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-sm uppercase tracking-wider">
          <th class="border px-3 py-2">æ”¶æ”¯</th>
          <th class="border px-3 py-2">é¡åˆ¥</th>
          <th class="border px-3 py-2">é …ç›®</th>
          <th class="border px-3 py-2">1æœˆ</th>
          <th class="border px-3 py-2">2æœˆ</th>
          <th class="border px-3 py-2">3æœˆ</th>
          <th class="border px-3 py-2">4æœˆ</th>
          <th class="border px-3 py-2">5æœˆ</th>
          <th class="border px-3 py-2">6æœˆ</th>
          <th class="border px-3 py-2">7æœˆ</th>
          <th class="border px-3 py-2">8æœˆ</th>
          <th class="border px-3 py-2">9æœˆ</th>
          <th class="border px-3 py-2">10æœˆ</th>
          <th class="border px-3 py-2">11æœˆ</th>
          <th class="border px-3 py-2">12æœˆ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2 class="text-2xl font-extrabold text-emerald-700 mt-12 mb-6">ğŸ“‘ åŸå§‹è³‡æ–™è¡¨æ ¼</h2>
  <div class="overflow-x-auto shadow-md rounded-lg">
    <table id="dataTable" class="table-auto w-full border border-gray-300 text-center text-sm bg-white rounded-lg overflow-hidden">
      <thead>
        <tr class="bg-gradient-to-r from-green-500 to-emerald-500 text-white uppercase tracking-wider">
          <th class="border px-3 py-2">æ—¥æœŸ</th>
          <th class="border px-3 py-2">é¡åˆ¥</th>
          <th class="border px-3 py-2">é …ç›®</th>
          <th class="border px-3 py-2">æ”¶å…¥</th>
          <th class="border px-3 py-2">æ”¯å‡º</th>
          <th class="border px-3 py-2">å‚™è¨»</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2 class="text-2xl font-extrabold text-rose-700 mt-12 mb-6">ğŸ© æ”¯å‡ºåˆ†é¡çµ±è¨ˆï¼ˆåœ“é¤…åœ–ï¼‰</h2>
  <div id="chart-container" class="mx-auto w-80 bg-white shadow-lg rounded-xl p-4">
    <canvas id="expenseChart" width="300" height="300"></canvas>
  </div>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbyPj4Wh4dU2xZLA95crADCLG5S5GuodC1SkPTUmYOAI7i7ArD8znGvO9gB8dO0p3Pux/exec';

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        const expenseMap = {};
        const monthlyMap = {};

        data.forEach(item => {
          const category = item["é¡åˆ¥"];
          const itemName = item["é …ç›®"];
          const date = new Date(item["æ—¥æœŸ"]);
          const month = date.getMonth();
          const income = parseInt(item["æ”¶å…¥"] || 0);
          const expense = parseInt(item["æ”¯å‡º"] || 0);
          const type = income > 0 ? "æ”¶å…¥" : "æ”¯å‡º";
          const key = `${type}|${category}|${itemName}`;

          if (!monthlyMap[key]) monthlyMap[key] = new Array(12).fill(0);
          monthlyMap[key][month] += income + expense;

          if (type === "æ”¯å‡º") {
            if (!expenseMap[category]) expenseMap[category] = 0;
            expenseMap[category] += expense;
          }
        });

        const monthlyTbody = document.querySelector('#monthlyTable tbody');
        const groups = { 'æ”¯å‡º': [], 'æ”¶å…¥': [] };

        for (const key in monthlyMap) {
          const [type, category, itemName] = key.split('|');
          groups[type].push({ key, category, itemName, data: monthlyMap[key] });
        }

        ["æ”¯å‡º", "æ”¶å…¥"].forEach(type => {
          let total = new Array(12).fill(0);
          groups[type].forEach(entry => {
            const tr = document.createElement('tr');
            tr.classList.add("transition", "hover:bg-yellow-50");
            tr.classList.add(type === "æ”¶å…¥" ? "bg-green-50" : "bg-rose-50");
            tr.innerHTML = `<td class="border px-2 py-1 font-semibold">${type}</td><td class="border px-2 py-1">${entry.category}</td><td class="border px-2 py-1">${entry.itemName}</td>` +
              entry.data.map(v => `<td class="border px-2 py-1">${v ? v.toLocaleString() : ""}</td>`).join("");
            monthlyTbody.appendChild(tr);
            for (let i = 0; i < 12; i++) total[i] += entry.data[i];
          });

          const totalTr = document.createElement('tr');
          totalTr.classList.add("font-bold", "bg-gradient-to-r", "from-yellow-300", "to-orange-300");
          totalTr.innerHTML = `<td class="border px-2 py-1">${type}</td><td class="border px-2 py-1" colspan="2">${type}ç¸½è¨ˆ</td>` +
            total.map(v => `<td class="border px-2 py-1">${v ? v.toLocaleString() : ""}</td>`).join("");
          monthlyTbody.appendChild(totalTr);

          const emptyTr = document.createElement('tr');
          emptyTr.innerHTML = `<td class="border px-2 py-1 text-center bg-white" colspan="15">&nbsp;</td>`;
          monthlyTbody.appendChild(emptyTr);
        });

        const tbody = document.querySelector('#dataTable tbody');
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.classList.add("hover:bg-indigo-50", "transition");
          ["æ—¥æœŸ", "é¡åˆ¥", "é …ç›®", "æ”¶å…¥", "æ”¯å‡º", "å‚™è¨»"].forEach(key => {
            const td = document.createElement('td');
            td.classList.add("border", "px-2", "py-1");
            td.textContent = row[key] || '';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        const labels = Object.keys(expenseMap);
        const values = Object.values(expenseMap);
        new Chart(document.getElementById('expenseChart'), {
          type: 'pie',
          data: {
            labels,
            datasets: [{
              label: 'æ”¯å‡ºçµ±è¨ˆ',
              data: values,
              backgroundColor: ['#f87171','#facc15','#34d399','#60a5fa','#a78bfa','#fb923c','#ec4899'],
            }]
          }
        });
      });
  </script>
</body>
</html>