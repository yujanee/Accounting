<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>記帳統計表</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans p-8 bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">
  <h2 class="text-2xl font-extrabold text-indigo-700 mb-6">📊 收支月別明細統計表</h2>

  <div class="overflow-x-auto shadow-lg rounded-lg">
    <table id="monthlyTable" class="table-auto w-full border border-gray-300 text-center text-sm bg-white rounded-lg overflow-hidden">
      <thead>
        <tr class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-sm uppercase tracking-wider">
          <th class="border px-3 py-2">收支</th>
          <th class="border px-3 py-2">類別</th>
          <th class="border px-3 py-2">項目</th>
          <th class="border px-3 py-2">1月</th>
          <th class="border px-3 py-2">2月</th>
          <th class="border px-3 py-2">3月</th>
          <th class="border px-3 py-2">4月</th>
          <th class="border px-3 py-2">5月</th>
          <th class="border px-3 py-2">6月</th>
          <th class="border px-3 py-2">7月</th>
          <th class="border px-3 py-2">8月</th>
          <th class="border px-3 py-2">9月</th>
          <th class="border px-3 py-2">10月</th>
          <th class="border px-3 py-2">11月</th>
          <th class="border px-3 py-2">12月</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2 class="text-2xl font-extrabold text-emerald-700 mt-12 mb-6">📑 原始資料表格</h2>
  <div class="overflow-x-auto shadow-md rounded-lg">
    <table id="dataTable" class="table-auto w-full border border-gray-300 text-center text-sm bg-white rounded-lg overflow-hidden">
      <thead>
        <tr class="bg-gradient-to-r from-green-500 to-emerald-500 text-white uppercase tracking-wider">
          <th class="border px-3 py-2">日期</th>
          <th class="border px-3 py-2">類別</th>
          <th class="border px-3 py-2">項目</th>
          <th class="border px-3 py-2">收入</th>
          <th class="border px-3 py-2">支出</th>
          <th class="border px-3 py-2">備註</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2 class="text-2xl font-extrabold text-rose-700 mt-12 mb-6">🍩 支出分類統計（圓餅圖）</h2>
  <div id="chart-container" class="mx-auto w-80 bg-white shadow-lg rounded-xl p-4">
    <canvas id="expenseChart" width="300" height="300"></canvas>
  </div>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbyPj4Wh4dU2xZLA95crADCLG5S5GuodC1SkPTUmYOAI7i7ArD8znGvO9gB8dO0p3Pux/exec';

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        const expenseMap = {};
        const monthlyMap = {};

        data.forEach(item => {
          const category = item["類別"];
          const itemName = item["項目"];
          const date = new Date(item["日期"]);
          const month = date.getMonth();
          const income = parseInt(item["收入"] || 0);
          const expense = parseInt(item["支出"] || 0);
          const type = income > 0 ? "收入" : "支出";
          const key = `${type}|${category}|${itemName}`;

          if (!monthlyMap[key]) monthlyMap[key] = new Array(12).fill(0);
          monthlyMap[key][month] += income + expense;

          if (type === "支出") {
            if (!expenseMap[category]) expenseMap[category] = 0;
            expenseMap[category] += expense;
          }
        });

        const monthlyTbody = document.querySelector('#monthlyTable tbody');
        const groups = { '支出': [], '收入': [] };

        for (const key in monthlyMap) {
          const [type, category, itemName] = key.split('|');
          groups[type].push({ key, category, itemName, data: monthlyMap[key] });
        }

        ["支出", "收入"].forEach(type => {
          let total = new Array(12).fill(0);
          groups[type].forEach(entry => {
            const tr = document.createElement('tr');
            tr.classList.add("transition", "hover:bg-yellow-50");
            tr.classList.add(type === "收入" ? "bg-green-50" : "bg-rose-50");
            tr.innerHTML = `<td class="border px-2 py-1 font-semibold">${type}</td><td class="border px-2 py-1">${entry.category}</td><td class="border px-2 py-1">${entry.itemName}</td>` +
              entry.data.map(v => `<td class="border px-2 py-1">${v ? v.toLocaleString() : ""}</td>`).join("");
            monthlyTbody.appendChild(tr);
            for (let i = 0; i < 12; i++) total[i] += entry.data[i];
          });

          const totalTr = document.createElement('tr');
          totalTr.classList.add("font-bold", "bg-gradient-to-r", "from-yellow-300", "to-orange-300");
          totalTr.innerHTML = `<td class="border px-2 py-1">${type}</td><td class="border px-2 py-1" colspan="2">${type}總計</td>` +
            total.map(v => `<td class="border px-2 py-1">${v ? v.toLocaleString() : ""}</td>`).join("");
          monthlyTbody.appendChild(totalTr);

          const emptyTr = document.createElement('tr');
          emptyTr.innerHTML = `<td class="border px-2 py-1 text-center bg-white" colspan="15">&nbsp;</td>`;
          monthlyTbody.appendChild(emptyTr);
        });

        const tbody = document.querySelector('#dataTable tbody');
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.classList.add("hover:bg-indigo-50", "transition");
          ["日期", "類別", "項目", "收入", "支出", "備註"].forEach(key => {
            const td = document.createElement('td');
            td.classList.add("border", "px-2", "py-1");
            td.textContent = row[key] || '';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        const labels = Object.keys(expenseMap);
        const values = Object.values(expenseMap);
        new Chart(document.getElementById('expenseChart'), {
          type: 'pie',
          data: {
            labels,
            datasets: [{
              label: '支出統計',
              data: values,
              backgroundColor: ['#f87171','#facc15','#34d399','#60a5fa','#a78bfa','#fb923c','#ec4899'],
            }]
          }
        });
      });
  </script>
</body>
</html>